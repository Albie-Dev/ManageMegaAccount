@page "/custom-table"

@using System.Linq
@inject IJSRuntime JS

<div class="container my-4">
    <div class="d-flex flex-row-reverse mb-3">
        <!-- Filter Icon -->
        <button class="btn btn-outline-primary" @onclick="ToggleFilterPanel">
            <i class="bi bi-funnel"></i>
        </button>
        <!-- Choose Column Icon -->
        <DropdownCheckboxList Title="" Items="columns" OnApply="ApplyColumnSelection"
            OnCancel="CancelColumnSelection" />
        <!-- Search Input -->
        <input class="form-control w-auto" type="text" placeholder="Search..." @bind="searchQuery" @oninput="Search" />
    </div>

    @if (showFilterPanel)
    {
        <div class="position-fixed top-0 p-2 end-0 border bg-light shadow-lg rounded"
            style="width: 450px; height: 100vh; overflow-y: auto; display: flex; flex-direction: column;">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="panel-title">Panel title</h3>
                <button class="btn-close" @onclick="CloseFilterPanel"></button>
            </div>
            <hr class="my-2">
            <div class="Filter-Content flex-grow-1">
                <DateTimePicker LabelName="Ngày tạo" ModelData="NgayTaoModelData" Type="@CDateTimePickerType.DateTime" />
            </div>
            <hr>
            <div class="d-flex justify-content-end mt-auto">
                <button class="btn btn-sm btn-outline-secondary me-2 bi bi-x" @onclick="CloseFilterPanel">Hủy bỏ</button>
                <button class="btn btn-sm btn-outline-primary" @onclick="ApplyFilter">Apply Filter</button>
            </div>
        </div>


    }
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                @foreach (var column in columns.Where(c => c.IsSelected))
                {
                    <th>@column.Name</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var row in filteredData ?? new List<Dictionary<string, object>>())
            {
                <tr>
                    @foreach (var column in columns.Where(c => c.IsSelected))
                    {
                        <td>@row[column.Value.ToString() ?? string.Empty]</td>
                    }
                </tr>
            }
        </tbody>
    </table>

    <!-- Paging Controls -->
    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-outline-secondary me-3" @onclick="PreviousPage" disabled="@(!CanNavigatePrevious)">
            <i class="bi bi-chevron-left"></i> Previous
        </button>
        <span class="align-self-center">Page @currentPage of @totalPages</span>
        <button class="btn btn-outline-secondary ms-3" @onclick="NextPage" disabled="@(!CanNavigateNext)">
            <i class="bi bi-chevron-right"></i> Next
        </button>
    </div>
</div>

@code {
    // Sample data structure
    private List<Dictionary<string, object>> data = new List<Dictionary<string, object>>
{
new Dictionary<string, object> { { "Name", "John" }, { "Age", 30 }, { "Country", "USA" } },
new Dictionary<string, object> { { "Name", "Anna" }, { "Age", 25 }, { "Country", "Canada" } },
new Dictionary<string, object> { { "Name", "Mike" }, { "Age", 35 }, { "Country", "UK" } },
};

    // Columns configuration
    private List<DropdownItemModel> columns = new List<DropdownItemModel>
{
new DropdownItemModel { Name = "Name", Value = "Name", IsSelected = true },
new DropdownItemModel { Name = "Age", Value = "Age", IsSelected = true },
new DropdownItemModel { Name = "Country", Value = "Country", IsSelected = true },
};

    // Filter and Search state
    private DateTimePickerModelData NgayTaoModelData { get; set; } = new();
    private string? searchQuery;
    private string? filterValue;
    private List<Dictionary<string, object>>? filteredData;
    private bool showFilterPanel = false;
    private bool showColumnSelector = false;
    private int currentPage = 1;
    private int itemsPerPage = 2;
    private int totalPages => (int)Math.Ceiling((double)(filteredData?.Count ?? 0) / itemsPerPage);

    // When the component is initialized, filter data initially
    protected override void OnInitialized()
    {
        filteredData = data;
        base.OnInitialized();
    }

    // Method for toggling filter panel visibility
    private void ToggleFilterPanel()
    {
        showFilterPanel = !showFilterPanel;
    }

    // Method for toggling column selector panel visibility
    private void ToggleColumnSelector()
    {
        showColumnSelector = !showColumnSelector;
    }

    // Apply filter to the data
    private void ApplyFilter()
    {
        filteredData = data.Where(d => d.Values.Any(v => v.ToString().Contains(filterValue ?? string.Empty,
        StringComparison.OrdinalIgnoreCase))).ToList();
        ApplyPaging();
    }

    private void ApplyColumnSelection(List<DropdownItemModel> selectedColumns)
    {
        // Update the IsVisible property of columns based on selected columns
        foreach (var column in columns)
        {
            column.IsSelected = selectedColumns.Any(c => c.Name == column.Name && c.IsSelected);
        }
    }

    private void CancelColumnSelection()
    {
        showColumnSelector = false;
    }

    private void CloseFilterPanel()
    {
        showFilterPanel = false;
    }

    // Method to handle search query and filter data
    private void Search()
    {
        filteredData = data.Where(d => d.Values.Any(v => v.ToString().Contains(searchQuery ?? string.Empty,
        StringComparison.OrdinalIgnoreCase))).ToList();
        ApplyPaging();
    }

    // Apply paging after search/filter
    private void ApplyPaging()
    {
        var pagedData = filteredData?.Skip((currentPage - 1) * itemsPerPage).Take(itemsPerPage).ToList();
        filteredData = pagedData;
    }

    // Method for next page
    private void NextPage()
    {
        if (CanNavigateNext)
        {
            currentPage++;
            ApplyPaging();
        }
    }

    // Method for previous page
    private void PreviousPage()
    {
        if (CanNavigatePrevious)
        {
            currentPage--;
            ApplyPaging();
        }
    }

    // Check if there is a previous page
    private bool CanNavigatePrevious => currentPage > 1;

    // Check if there is a next page
    private bool CanNavigateNext => currentPage < totalPages;
}